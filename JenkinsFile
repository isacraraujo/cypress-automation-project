pipeline {
  agent any

  tools {
    nodejs 'NodeJS_24'
  }

  stages {
    stage('Instalar Dependências') {
      steps {
        bat 'npm install -D'
      }
    }

    stage('Executar Suíte de Testes de API') {
      steps {
        catchError(message:'Erro em Caso de Teste de API') {
          bat 'npx cypress run --spec "cypress/e2e/api/**/*"'
        }
      }
    }

    stage('Executar Suíte de Testes de Frontend(Application)') {
      steps {
        catchError(message:'Erro em Caso de Teste de Frontend') {
          bat 'npx cypress run --spec "cypress/e2e/application/**/*"'
        }
      }
    }

    stage('Publicar Relatório de Execução') {
      when {
        expression { fileExists('cypress/reports/report.html') }
      }
      steps {
        catchError(message:'Erro ao Emitir Relatórios') {
          publishHTML([
            allowMissing: true,
            alwaysLinkToLastBuild: true,
            keepAll: true,
            reportDir: 'cypress/reports',
            reportFiles: 'report.html',
            reportName: 'Relatório de Testes Automatizados em Cypress'
          ])
        }
      }
    }
  }

  post {
    failure {
      mail to: '1s4c.3d@gmail.com',
        subject: "Pipeline falhou: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
        body: "Veja detalhes: ${env.BUILD_URL}"
    }
  }
}
